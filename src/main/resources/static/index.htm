<html>
<head>
<title>Hello cantine!</title>
<!-- DataTables CSS -->
<link rel="stylesheet" type="text/css"
	href="css/jquery.dataTables.min.css">

<link href="css/cantine.css" rel="stylesheet" type="text/css" />
<!-- jQuery -->
<script type="text/javascript" charset="utf8"
	src="js/jquery-1.11.1.js"></script>

<!-- DataTables -->
<script type="text/javascript" charset="utf8"
	src="js/jquery.dataTables.js"></script>
	
<script src="js/jquery.cookie.js"></script>
<script>
	var semaine; 
	var plats, header;
	var platsMail = [];
	$(document)
			.ready(
					function() {
						$(".nom").val($.cookie('nom'));
						$.ajax({
									url : "menu"
								})
								.done(
										function(data) {
											header = data.plats[0];
											data.plats.splice(0, 1);
											plats = data.plats;
											semaine = data.semaine;
											$('.semaine').append(data.semaine);

											$('.table').dataTable({
												"data" : plats,
												paging : false,
												searching : false,
												ordering : false,
												"columns" : [ {
													"title" : ""
												}, {
													"title" : header[1]
												}, {
													"title" : header[2]
												}, {
													"title" : header[3]
												}, {
													"title" : header[4]
												}, {
													"title" : header[5]
												} ]
											});

											var table = $('.table').DataTable();
											$('.table tbody')
													.on(
															'click',
															'td',
															function() {
																console
																		.debug("ligne"
																				+ table
																						.cell(
																								this)
																						.index().row
																				+ " column "
																				+ table
																						.cell(
																								this)
																						.index().column);
																if ($(this)
																		.hasClass(
																				'cell_selected')) {
																	$(this)
																			.removeClass(
																					'cell_selected');
																} else {
																	$(this)
																			.addClass(
																					'cell_selected');
																}
															});

										});

					});

	function email() {
		var sBody = "Bonjour voici mon choix\n";
		var table = $('.table').DataTable();
		cells = table.cells(".cell_selected");
		
		for ( var i = 1; i < 6; i++) {
			platsMail[i - 1] = "\n" + header[i] + ":    ";
		}
		$.each(table.cells(".cell_selected").eq(0), function(cellIdx, i) {
			console.debug("\nNumero jour " + header[this.column] + " plat "
					+ table.cell(this.row, this.column).data());
			platsMail[this.column - 1] += " "
					+ table.cell(this.row, this.column).data() + " --- ";
		});

		sBody += platsMail.join("\n") + "\n\nMerci";
		console.debug(sBody);
		var sMailTo = "mailto:";
		sMailTo += escape("mg133@ansamble.fr") + "?subject="
				+ escape("choix: " + semaine) + "&body=" + escape(sBody);
		window.location.href = sMailTo;
	}

	function setUserChoix() {
		$.cookie('nom', $(".nom").val(), { expires: 365 });
		var now=new Date();
		var choix = {
				nom:$(".nom").val(),
				date:now.getTime(),
				plats:[]
		}
		j=0;
		$.each($('.table').DataTable().cells(".cell_selected").eq(0), function(cellIdx, i) {
			var plat= {
				nom:$('.table').DataTable().cell(this.row, this.column).data(),
				accompagnement:true
			}
			choix.plats[j++] = plat;
		});
		
		$.ajax({
			  type: "POST",
			  headers: {          
	                 Accept : "application/json",         
	                "Content-Type": "application/json"   
	  		},
			  url: "menu",
			  data: JSON.stringify(choix),
			  success:email(),
			  dataType: "json"
			});
	} 
	
</script>
</head> 
<body>
	<h2>Hello cantine!</h2>
	<div>
		<p class="semaine"></p>
		<p class="plats"></p>
		<p>
		<table class="table"></table>
		</p>
		<input placeholder="Nom" class="nom"/>
	</div>
	<button onClick='setUserChoix();'>Générer le mail</button>
</body>
</html>
